REM usage: startloadtest.cmd [Server:port] [NumConcurrentClients] [NumIterations]
REM Make sure Node.js is installed first

set SERVER_URI=%1
set NUM_CLIENTS=%2
set NUM_ITERATIONS=%3
set /A NUM_REQ_PER_ITERATION=10 * NUM_CLIENTS
set TEST_DATA_SMALL_FILE=testdatasmall.data
cmd /c npm install -g loadtest

ECHO. > %TEST_DATA_SMALL_FILE%
CALL :GenerateTestTextData 50 %TEST_DATA_SMALL_FILE%
CALL :RunTest
GOTO :EOF


:RunTest
SET /A LOOPIDX=0
:START_TEST
cmd /c loadtest -p testdatasmall.data -c %NUM_CLIENTS% -n %NUM_REQ_PER_ITERATION% -m POST --quiet ws://%SERVER_URI%/WebSocket/ >nul
SET /A LOOPIDX=LOOPIDX+1
if %LOOPIDX% GEQ %NUM_ITERATIONS% goto :EOF
GOTO :START_TEST


:GenerateTestTextData REM %1=LOOPCOUNT %2=FILENAME

SET /A LOOPIDX=0
SET /A LOOPCOUNT=%1
SET TESTDATA_CONTENT=01234567890123456789012345678901234567890012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789

:GENFILELOOP
ECHO %TESTDATA_CONTENT%  >> %2
SET /A LOOPIDX=LOOPIDX+1
if %LOOPIDX% GEQ %LOOPCOUNT% goto :EOF
GOTO :GENFILELOOP

:EOF