#!/bin/bash

## usage: startloadtest.sh [Server:port] [NumConcurrentClients] [NumIterations]

SERVER_URI=$1
NUM_CLIENTS=$2
NUM_ITERATIONS=$3
NUM_REQ_PER_ITERATION=$(($NUM_CLIENTS * 10))
echo $NUM_REQ_PER_ITERATION
TEST_DATA_SMALL_FILE="testdatasmall.data"

## sudo apt-get install nodejs
## sudo npm install -g loadtest

## Generate test data file
echo "Test data" > $TEST_DATA_SMALL_FILE
LOOPIDX=0
LOOPCOUNT=50
TESTDATA_CONTENT="01234567890123456789012345678901234567890012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789"
while [ $LOOPIDX -lt $LOOPCOUNT ]; do
    echo $TESTDATA_CONTENT  >> $TEST_DATA_SMALL_FILE
    let LOOPIDX=$LOOPIDX+1
done

## Run test in a loop

LOOPIDX=0
echo "start test"
while [ $LOOPIDX -lt $NUM_ITERATIONS ]; do
    loadtest -p testdatasmall.data -c $NUM_CLIENTS -n $NUM_REQ_PER_ITERATION -m POST --quiet ws://$SERVER_URI/WebSocket/
    let LOOPIDX=$LOOPIDX+1
done
